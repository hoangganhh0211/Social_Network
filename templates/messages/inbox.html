{% extends "base.html" %}
{% block title %}Tin nhắn{% endblock %}

{% block content %}
<div class="inbox-page">
<h2>Hộp thư</h2>

<div style="display: flex;">
    <!-- Danh sách Tin Nhắn Gần Đây -->
    <div style="width: 30%; border-right: 1px solid #ccc; padding-right: 10px;">
        <h4>Trò chuyện gần đây</h4>
        {% for conv in conversations %}
            <div>
                <a href="{{ url_for('messages.conversation', other_id=conv.other_id) }}">
                    {{ conv.other_username }} <br>
                    <small>{{ conv.last_msg[:20] }}… ({{ conv.timestamp.strftime('%Y-%m-%d %H:%M') }})</small>
                </a>
                <hr>
            </div>
        {% else %}
            <p>Chưa có cuộc trò chuyện nào.</p>
        {% endfor %}
    </div>

    <!-- Nội dung Chat hoặc Tạo mới -->
    <div style="width: 70%; padding-left: 10px;">
        {% if other %}
            <h4>Chat với {{ other.username }}</h4>
            <div id="chat-window" style="height: 300px; overflow-y: scroll; border: 1px solid #ddd; padding: 5px;">
                {% for msg in conversation %}
                    {% if msg.sender_id == session.user_id %}
                        <p style="text-align: right;" id="msg-{{ msg.id }}">
                            <strong>{{ session.username }}:</strong> {{ msg.content }} <br>
                            <small>{{ msg.created_at.strftime('%Y-%m-%d %H:%M') }}</small><br>
                            <small style="color: {% if msg.is_read %}green{% else %}gray{% endif %}; font-style: italic;">
                                {% if msg.is_read %}
                                    Đã xem
                                {% else %}
                                    Đã gửi
                                {% endif %}
                            </small>
                        </p>
                    {% else %}
                        <p id="msg-{{ msg.id }}">
                            <strong>{{ other.username }}:</strong> {{ msg.content }} <br>
                            <small>{{ msg.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </p>
                    {% endif %}
                    <hr>
                {% endfor %}
            </div>

            <form id="chat-form">
                <textarea id="message-input" name="content" rows="2" cols="50" placeholder="Nhập tin nhắn..."></textarea><br>
                <button type="submit">Gửi</button>
            </form>
        {% else %}
            <h4>Tạo tin nhắn mới</h4>
            <form method="POST">
                <label>Gửi đến:</label>
                <select name="to_id">
                    {% for u in all_users %}
                        <option value="{{ u.user_id }}">{{ u.username }}</option>
                    {% endfor %}
                </select><br><br>
                <textarea name="content" rows="3" cols="50" placeholder="Nội dung..."></textarea><br><br>
                <button type="submit">Gửi</button>
            </form>
        {% endif %}
    </div>
</div>
</div>

{% if other %}
<!-- Gắn Socket.IO và JS -->
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>

<!-- Biến toàn cục cho JS -->
<script>
    window.SENDER_ID = {{ session.user_id }};
    window.RECEIVER_ID = {{ other.user_id }};
    window.SENDER_USERNAME = "{{ session.username }}";
    window.RECEIVER_USERNAME = "{{ other.username }}";
</script>

<!-- Import file JS riêng -->
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
{% endif %}
{% endblock %}
